{% extends "base.html" %}
{% block content %}

<section class="card">
  <h2>Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„</h2>
  <form action="{{ url_for('list_servers') }}" method="post" enctype="multipart/form-data">
    <input type="file" name="excel_file_multi" required>
    <button type="submit">Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª</button>
  </form>
</section>

{% if server_list %}
<section class="card">
  <form action="{{ url_for('forecast_multi') }}" method="post" style="display:flex; gap:20px; align-items:flex-start; flex-wrap:wrap;">

    
    <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª -->
<div style="flex:1; min-width:280px;">
  <label for="servers">Ø§Ø®ØªØ± Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª:</label>
  <select id="servers" name="servers" multiple>
    {% for s in server_list %}
      <option value="{{ s }}">{{ s }}</option>
    {% endfor %}
  </select>

  <!-- Ø²Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„ -->
  <button type="button" id="select-all-btn" style="margin-top:8px;">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
</div>


    
   <!-- Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¯Ø© Ø§Ù„ØªÙ†Ø¨Ø¤ -->
<div style="flex:1; min-width:200px;">
  <label for="months">Ù…Ø¯Ø© Ø§Ù„ØªÙ†Ø¨Ø¤:</label>
  <div style="display:flex; flex-direction:column; gap:6px; padding:0;">
    <label style="display:flex; align-items:center; gap:6px; font-weight:500; color:#333;">
      <input type="radio" name="months" value="3" required> Ù£ Ø£Ø´Ù‡Ø±
    </label>
    <label style="display:flex; align-items:center; gap:6px; font-weight:500; color:#333;">
      <input type="radio" name="months" value="6"> Ù¦ Ø£Ø´Ù‡Ø±
    </label>
    <label style="display:flex; align-items:center; gap:6px; font-weight:500; color:#333;">
      <input type="radio" name="months" value="8"> Ù¨ Ø£Ø´Ù‡Ø±
    </label>
    <label style="display:flex; align-items:center; gap:6px; font-weight:500; color:#333;">
      <input type="radio" name="months" value="12"> Ù¡Ù¢ Ø´Ù‡Ø±
    </label>
  </div>
</div>

    <!-- Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ -->
    <div style="flex:0 0 auto; align-self:center;">
      <button type="submit">ØªØ´ØºÙŠÙ„ ÙˆØªØ­Ù„ÙŠÙ„</button>
    </div>

  </form>
</section>
{% endif %}


{% if multi_table %}
<section class="card">
  <h3>ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ({{ months }} Ø£Ø´Ù‡Ø± Ù‚Ø§Ø¯Ù…Ø©)</h3>

  <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Ø§Ø³Ù… Ø§Ù„Ø³ÙŠØ±ÙØ±</th>
          {% for col in labels_forecast_only %}
            <th>{{ col }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for r in multi_table %}
          <tr>
            <td>{{ r['Ø§Ø³Ù… Ø§Ù„Ø³ÙŠØ±ÙØ±'] }}</td>
            {% for col in labels_forecast_only %}
              <td>{{ r[col] if r[col] is not none else '' }}</td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Ø§Ù„Ø´Ø§Ø±ØªØ§Øª -->
  <div id="charts-container" class="charts-grid"></div>
</section>
{% endif %}

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const serversSelect = document.getElementById("servers");
    const choices = new Choices(serversSelect, {
      removeItemButton: true,
      searchEnabled: true,
      placeholderValue: "Ø§Ø¨Ø­Ø« ÙˆØ§Ø®ØªØ± Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª...",
      noResultsText: "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬",
      duplicateItemsAllowed: false  // ğŸ”¥ ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
    });

    // Ø²Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
    document.getElementById("select-all-btn").addEventListener("click", function() {
      const allValues = Array.from(serversSelect.options).map(o => o.value);
      choices.removeActiveItems();  // ğŸ”¥ ÙŠÙ…Ø³Ø­ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
      choices.setChoiceByValue(allValues); // ğŸ”¥ ÙŠØ­Ø¯Ø¯ Ø§Ù„ÙƒÙ„ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©
    });
  });

  /* Ø´ÙÙØ±Ø© Ø§Ù„Ø±Ø³ÙˆÙ… (ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ) */
  {% if chart_labels_multi and chart_datasets_multi %}
  const container = document.getElementById('charts-container');
  container.innerHTML = '';
  const servers = [...new Set({{ chart_datasets_multi | tojson }}.map(d => d.label.split(' ')[0]))];

  if (servers.length === 1) {
    const wrapper = document.createElement('div');
    wrapper.style.textAlign = "center";
    wrapper.style.gridColumn = "1 / -1";
    container.appendChild(wrapper);

    const title = document.createElement('h3');
    title.innerText = servers[0];
    title.style.margin = "15px 0";
    title.style.fontSize = "18px";
    title.style.fontWeight = "600";
    wrapper.appendChild(title);

    const canvas = document.createElement('canvas');
    canvas.style.maxWidth = "600px";
    canvas.style.margin = "0 auto";
    wrapper.appendChild(canvas);

    new Chart(canvas.getContext('2d'), {
      type: 'line',
      data: {
        labels: {{ chart_labels_multi | tojson }},
        datasets: {{ chart_datasets_multi | tojson }}
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'top' } },
        scales: {
          y: { beginAtZero: true, grace: '10%', title: { display: true, text: 'Ø§Ù„Ø­Ø¬Ù… (GB)' } },
          x: { title: { display: true, text: 'Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø´Ù‡Ø±/Ø³Ù†Ø©)' } }
        }
      }
    });
  } else {
    servers.forEach(srv => {
      const wrapper = document.createElement('div');
      wrapper.style.textAlign = "center";

      const title = document.createElement('h4');
      title.innerText = srv;
      title.style.margin = "10px 0";
      title.style.fontSize = "16px";
      title.style.fontWeight = "600";
      wrapper.appendChild(title);

      const canvas = document.createElement('canvas');
      canvas.style.maxWidth = "350px";
      canvas.style.maxHeight = "200px";
      wrapper.appendChild(canvas);

      container.appendChild(wrapper);

      const ds = {{ chart_datasets_multi | tojson }}.filter(d => d.label.startsWith(srv));

      new Chart(canvas.getContext('2d'), {
        type: 'line',
        data: {
          labels: {{ chart_labels_multi | tojson }},
          datasets: ds
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, grace: '10%' },
            x: { title: { display: true, text: 'Ø§Ù„ØªØ§Ø±ÙŠØ®' } }
          }
        }
      });
    });
  }
  {% endif %}
</script>
{% endblock %}

